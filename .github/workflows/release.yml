name: Release

on:
  release:
    types: [published]

jobs:
  build-xcframework:
    name: Build and Attach XCFramework
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      DEVELOPER_DIR: /Applications/Xcode_26.1.app/Contents/Developer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
      - name: Build XCFramework
        run: |
          chmod +x ./build_xcframework.sh
          ./build_xcframework.sh
      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: Bagbutik.xcframework
          path: output/Bagbutik.xcframework.zip
      - name: Compute SwiftPM checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum output/Bagbutik.xcframework.zip)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
      - name: Capture Xcode & Swift versions
        id: toolchain
        run: |
          XCODE_VERSION=$(xcodebuild -version | head -n 1 | sed 's/Xcode //')
          SWIFT_VERSION=$(swift --version | sed -n 's/.*Swift version \([0-9.]*\).*/\1/p')
          echo "xcode=$XCODE_VERSION" >> $GITHUB_OUTPUT
          echo "swift=$SWIFT_VERSION" >> $GITHUB_OUTPUT
      - name: Update GitHub Release with checksum
        uses: softprops/action-gh-release@v2
        with:
          append_body: true
          body: |
            ### XCFramework

            - Built with: Xcode ${{ steps.toolchain.outputs.xcode }} (Swift ${{ steps.toolchain.outputs.swift }})
            - SwiftPM checksum: `${{ steps.checksum.outputs.checksum }}`

            ```swift
            .binaryTarget(
                name: "Bagbutik",
                url: "https://github.com/MortenGregersen/Bagbutik/releases/download/${{ github.event.release.tag_name }}/Bagbutik.xcframework.zip",
                checksum: "${{ steps.checksum.outputs.checksum }}"
            )
            ```
