name: Release

on:
  release:
    types: [published]

jobs:
  build-xcframework:
    name: Build and Attach XCFramework
    runs-on: macos-latest
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.1.app/Contents/Developer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
      
      - name: Build XCFramework
        run: |
          set -e
          
          # Create output directory
          mkdir -p output
          
          # Define the library products to build
          PRODUCTS=(
            "Bagbutik-Core"
            "Bagbutik-Models"
            "Bagbutik-AppStore"
            "Bagbutik-GameCenter"
            "Bagbutik-Marketplaces"
            "Bagbutik-Provisioning"
            "Bagbutik-Reporting"
            "Bagbutik-TestFlight"
            "Bagbutik-Users"
            "Bagbutik-Webhooks"
            "Bagbutik-XcodeCloud"
          )
          
          # Build all products for all Apple platforms
          echo "Building for iOS..."
          swift build -c release --product Bagbutik --destination generic/platform=iOS
          
          echo "Building for iOS Simulator..."
          swift build -c release --product Bagbutik --destination generic/platform=iOS\ Simulator
          
          echo "Building for macOS..."
          swift build -c release --product Bagbutik --destination generic/platform=macOS
          
          echo "Building for tvOS..."
          swift build -c release --product Bagbutik --destination generic/platform=tvOS
          
          echo "Building for tvOS Simulator..."
          swift build -c release --product Bagbutik --destination generic/platform=tvOS\ Simulator
          
          echo "Building for watchOS..."
          swift build -c release --product Bagbutik --destination generic/platform=watchOS
          
          echo "Building for watchOS Simulator..."
          swift build -c release --product Bagbutik --destination generic/platform=watchOS\ Simulator
          
          # Find build artifacts for each product and create XCFrameworks
          for PRODUCT in "${PRODUCTS[@]}"; do
            echo "Creating XCFramework for $PRODUCT..."
            
            PRODUCT_UNDERSCORED="${PRODUCT//-/_}"
            XCFRAMEWORK_ARGS=()
            
            # Find libraries for each platform
            IOS_LIB=$(find .build -path "*-apple-ios/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            IOS_SIM_LIB=$(find .build -path "*-apple-ios-simulator/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            MACOS_LIB=$(find .build -path "*-apple-macosx/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            TVOS_LIB=$(find .build -path "*-apple-tvos/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            TVOS_SIM_LIB=$(find .build -path "*-apple-tvos-simulator/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            WATCHOS_LIB=$(find .build -path "*-apple-watchos/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            WATCHOS_SIM_LIB=$(find .build -path "*-apple-watchos-simulator/release/lib${PRODUCT_UNDERSCORED}.a" 2>/dev/null | head -1)
            
            # Build arguments array
            [ -n "$IOS_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$IOS_LIB")
            [ -n "$IOS_SIM_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$IOS_SIM_LIB")
            [ -n "$MACOS_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$MACOS_LIB")
            [ -n "$TVOS_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$TVOS_LIB")
            [ -n "$TVOS_SIM_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$TVOS_SIM_LIB")
            [ -n "$WATCHOS_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$WATCHOS_LIB")
            [ -n "$WATCHOS_SIM_LIB" ] && XCFRAMEWORK_ARGS+=(-library "$WATCHOS_SIM_LIB")
            
            if [ ${#XCFRAMEWORK_ARGS[@]} -gt 0 ]; then
              xcodebuild -create-xcframework \
                "${XCFRAMEWORK_ARGS[@]}" \
                -output "output/${PRODUCT}.xcframework"
            else
              echo "Warning: No libraries found for $PRODUCT"
            fi
          done
          
          # Create a zip archive of all XCFrameworks
          cd output
          zip -r Bagbutik.xcframework.zip *.xcframework
          cd ..
          
          # Verify what was created
          echo "Created XCFrameworks:"
          ls -lh output/
      
      - name: Upload XCFramework to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./output/Bagbutik.xcframework.zip
          asset_name: Bagbutik.xcframework.zip
          asset_content_type: application/zip
